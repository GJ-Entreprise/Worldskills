<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Sécuriser - Les VLAN : - Worldskills - GJ enterprise</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "S\u00e9curiser - Les VLAN :";
    var mkdocs_page_input_path = "Cisco\\S\u00e9curiser VLAN.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Worldskills - GJ enterprise</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Welcome to GJ enterprise documentation website !</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../ajouter_documentations/">Ajout_documentations.md</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">CentOs</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../CentOs/Installer_apache_httpd/">Installation d'un serveur Aapche HTTPD</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../CentOs/apache_TLS_SSL/">Apache / TLS / SSL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../CentOs/management_utilisateur_%26_groupes/">Management utilisateur & groupes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../CentOs/regle_parfeu/">Mise en place de règles firewall</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Cisco</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../Alerter%20activit%C3%A9/">Alerter - Pic d'activité :</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Deployer%20un%20VLAN%20de%20management/">Deployer - VLAN de management :</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Segmenter%20les%20communications%20et%20les%20filtrer/">Segmenter - les communications :</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../S%C3%A9curiser%20%20CDP%20et%20LLDP/">Sécuriser - CDP et LLDP :</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../S%C3%A9curiser%20ARP%20et%20DHCP/">Sécuriser - ARP et DHCP :</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Sécuriser - Les VLAN :</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#1-le-double-tag">1 Le double tag :</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#11-le-laboratoire">1.1 Le laboratoire :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#12-explications">1.2 Explications :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#13-attaque">1.3 Attaque :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#14-mitigation">1.4 Mitigation :</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-le-protocole-dtp">2 Le protocole DTP :</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#21-le-laboratoire">2.1 Le laboratoire :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#22-explications">2.2 Explications :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#23-attaque">2.3 Attaque :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#24-mitigation">2.4 Mitigation :</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3-conclusion">3 Conclusion :</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../S%C3%A9curiser%20les%20mots%20de%20passe/">Sécuriser - Les mots de passe sur Cisco :</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Windows   AD$</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../Windows%20-%20AD%24/Activer%20le%20chiffrement%20des%20donn%C3%A9es/">Activer le chiffrement des données :</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Windows%20-%20AD%24/Mot%20de%20passe/">Mot de passe - robustesse et rotation  :</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Windows%20-%20AD%24/Renforcer%20RDP/">Renforcer le protocole RDP :</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Worldskills - GJ enterprise</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Cisco &raquo;</li>
        
      
    
    <li>Sécuriser - Les VLAN :</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="securiser-les-vlan">Sécuriser - Les VLAN :</h1>
<p>Ressource :</p>
<ul>
<li><a href="https://cybersecurity.att.com/blogs/security-essentials/vlan-hopping-and-mitigation">https://cybersecurity.att.com/blogs/security-essentials/vlan-hopping-and-mitigation</a></li>
<li><a href="https://www.notsosecure.com/exploiting-vlan-double-tagging/">https://www.notsosecure.com/exploiting-vlan-double-tagging/</a></li>
<li><a href="https://networklessons.com/cisco/ccnp-switch/vlan-hopping">https://networklessons.com/cisco/ccnp-switch/vlan-hopping</a></li>
</ul>
<p>Cette documentation illustre les méthodes pour mitiguer les attaques de rebonds des VLAN.
Il existe deux méthodes pour réaliser cette attaque :</p>
<ul>
<li>Double tag,</li>
<li>Protocole DTP,</li>
</ul>
<hr />
<h2 id="1-le-double-tag">1 Le double tag :</h2>
<h3 id="11-le-laboratoire">1.1 Le laboratoire :</h3>
<p>Voici le laboratoire que j'utilise pour ce lab :
<img alt="img" src="../../images/Cisco/VLAN-secure/network.png" />
<div align="center"><strong><em>Illustration 1 :</em></strong> <em>Plan réseau du laboratoire.</em></div></p>
<p>Ce lab est composer d'un VLAN :</p>
<ul>
<li>VLAN 10 ; 192.168.10.0/24</li>
</ul>
<p>Le PC-1 se rouve dans le VLAN 10 et l'attaquant dajns le VLAN 1 (par défaut).
Une liason <strong>trunk</strong> est entre le switch SW-1 et le dwitch SW-2.</p>
<p>Script de configuration du switch SW-1 :</p>
<pre><code class="text">SW-1(config)# vlan 1
SW-1(config-vlan)# no shutdown
SW-1(config-vlan)# exit

SW-1(config)# vlan 10
SW-1(config-vlan)# name vlan_1
SW-1(config-vlan)# no shutdown
SW-1(config-vlan)# exit

SW-1(config)# interface vlan 10
SW-1(config-if)# ip address 192.168.10.10 255.255.255.0
SW-1(config-if)#no shutdown
SW-1(config-if)# exit

SW-1(config)# interface GigabitEthernet0/0
SW-1(config-if)# switchport mode access
SW-1(config-if)# switchport access vlan 10
SW-1(config-if)# no shutdown
SW-1(config-if)# exit

SW-1(config)# interface GigabitEthernet3/0
SW-1(config-if)# switchport trunk encapsulation dot1q
SW-1(config-if)# switchport mode trunk
SW-1(config-if)# switchport trunk allowed vlan 10
SW-1(config-if)# switchport trunk native vlan 1
SW-1(config-if)# no shutdown
SW-1(config-if)# exit

SW-1(config)# hostname SW-1
SW-1(config)# do wr
</code></pre>

<p>Script de configuration du switch SW-2 :</p>
<pre><code class="text">SW-2(config)# vlan 1
SW-2(config-vlan)# no shutdown
SW-2(config-vlan)# exit

SW-2(config)# vlan 10
SW-2(config-vlan)# name vlan_1
SW-2(config-vlan)# no shutdown
SW-2(config-vlan)# exit

SW-2(config)# interface vlan 10
SW-2(config-if)# ip address 192.168.10.20 255.255.255.0
SW-2(config-if)# no shutdown
SW-2(config-if)# exit

SW-2(config)# interface GigabitEthernet0/0
SW-2(config-if)# switchport mode access
SW-2(config-if)# switchport access vlan 1
SW-2(config-if)# no shutdown
SW-2(config-if)# exit

SW-2(config)# interface GigabitEthernet3/0
SW-2(config-if)# switchport trunk encapsulation dot1q
SW-2(config-if)# switchport mode trunk
SW-2(config-if)# switchport trunk allowed vlan 10
SW-2(config-if)# switchport trunk native vlan 1
SW-2(config-if)# no shutdown
SW-2(config-if)# exit

SW-2(config)# hostname SW-2
SW-2(config)# do wr
</code></pre>

<hr />
<h3 id="12-explications">1.2 Explications :</h3>
<p>Cette attaque est possible uniquement quand une liason trunk est configuré entre deux switch.
Pour rappel la norme dot1q ajoute un champ dans les trames ethernet, ce champ specifie le numéros du vlan qui est associé à la trame.
L'objectif de cette action est de diffusé uniquement la trame au vlan associé.</p>
<p>Par exemple une trame de demande ARP est émise par un poste elle est diffusé dans le VLAN 10 :</p>
<ul>
<li>1 Le switch regarde les ports qui sont positionné dans le VLAN 10 et transmet la trame,</li>
<li>2 Ensuite le switch ajoute un champ <strong>VLAN_ID</strong> dans la trame ethernet qui correspond au numéros de VLAN (VLAN 10),</li>
<li>3 Le switch transmet cette trame au second switch,</li>
<li>4 Le second switch ouvre la trame récupère la valeur de VLAN_ID,</li>
<li>5 Et il transmet la trame aux ports configurés dans le VLAN 10,</li>
</ul>
<p>Dans ce contexte, le poste envoie au switch (avant l'étape 1) une trame doublement entaguée :
<img alt="img" src="../../images/Cisco/VLAN-secure/double_tag.png" />
<div align="center"><strong><em>Illustration 2 :</em></strong> <em>Trame double tag.</em></div></p>
<p>L'attaquant envoie une trame avec deux balise 802.1Q :</p>
<ul>
<li>La balise interne correspond au vlan natif,</li>
<li>La balise externe correspond au vlan que l'attaquant souhaite contacter,</li>
</ul>
<p>Le switch reçoit cette trame et il effectue les actions suivantes :</p>
<ul>
<li>1 Supprime la première entête 802.1Q (vlan natif),</li>
<li>2 Il relais la trame à l'ID de vlan de la seconde entête,</li>
</ul>
<p>Définition VLAN natif :</p>
<p><strong><em>Certaines trames véhiculées sur un trunk ne sont pas marquées d’un tag dot1q.
Dés lors il faut pouvoir les placer quelque part. C’est là qu’intervient le vlan natif.
Le vlan natif, est le vlan dans lequel sont véhiculées les trames non taguées dot1q.
Donc si un switch reçoit sur une interface trunk une trame ethernet standard, il la placera dans ce vlan natif, en quelque sorte, un vlan par défaut (de marquage).
Sur les équipements Cisco, certains protocoles comme CDP ou DTP sont véhiculés dans des trames non taguées et donc dans le vlan natif.</em></strong></p>
<p>Le vlan natif est utilisé lorsqu'un port configuré en trunk reçoit une trame non taguée.
Lorsqu'un port trunk reçoit une trame non taguée il l'envoie dans le vlan natif.</p>
<p>Par défaut le vlan natif est le vlan 1 sur les witchs Cisco.
L'attaque de double tag est unidirectionnel l'attaquant peux envoyer des trames mais il n'obtiendra pas de réponse.
Ce qui permet par exemple de réaliser un DoS.</p>
<hr />
<h3 id="13-attaque">1.3 Attaque :</h3>
<p>A l'aide de scapy l'attaquant envoie ce paquet :</p>
<pre><code class="python">scapy
sendp(Ether(dst='ff:ff:ff:ff:ff:ff', src='0E:5C:49:19:32:BF')/Dot1Q(vlan=1)/Dot1Q(vlan=20)/IP(dst='255.255.255.255', src='192.168.10.1')/ICMP(), iface='eth0')
</code></pre>

<hr />
<h3 id="14-mitigation">1.4 Mitigation :</h3>
<p>Pour mitiger l'attaque double tagged il faut changer la valeur du vlan natif celui doit correspondre à deux critères :</p>
<ul>
<li>Dédié un vlan uniquement à cet usage,</li>
<li>Le VLAN natif doit être identique entre les liasons trunk,</li>
</ul>
<p>Mitigations sur SW-1 :</p>
<pre><code class="text">SW-1(config)# vlan 99
SW-1(config-vlan)# name natif
SW-1(config-vlan)# no shutdown
SW-1(config-vlan)# exit

SW-1(config)# interface GigabitEthernet 3/0
SW-1(config-if)# switchport trunk native vlan 99
SW-1(config-if)# exit
</code></pre>

<p>Mitigations sur SW-2 :</p>
<pre><code class="text">SW-2(config)# vlan 99
SW-2(config-vlan)# name natif
SW-2(config-vlan)# no shutdown
SW-2(config-vlan)# exit

SW-2(config)# interface GigabitEthernet 3/0
SW-2(config-if)# switchport trunk native vlan 99
SW-2(config-if)# exit
</code></pre>

<hr />
<h2 id="2-le-protocole-dtp">2 Le protocole DTP :</h2>
<h3 id="21-le-laboratoire">2.1 Le laboratoire :</h3>
<p>Voici le laboratoire que j'utilise pour ce lab :
<img alt="img" src="../../images/Cisco/VLAN-secure/network-2.png" />
<div align="center"><strong><em>Illustration 3 :</em></strong> <em>Plan du laboratoire.</em></div></p>
<p>Voici le script de configuration du switch SW-1 :</p>
<pre><code class="text">SW-2(config)# interface GigabitEthernet0/0
SW-2(config-if)# switchport mode dynamic auto
SW-2(config-if)# exit

SW-2(config)# hostname SW-1
SW-2(config)# do wr
</code></pre>

<hr />
<h3 id="22-explications">2.2 Explications :</h3>
<p>Le protocole DTP (Dynamic Trunk Protocol) est un protocole propriétaire Cisco qui permet de négocier les liason trunk avec d'autres équipement Cisco.
Par défaut il est activé et il permet à un attaquant de monter une liason trunk entreson PC et le switch.
Ce qui à pour conséquence qu'il peut détourner tous les vlan configurés sur le switch.</p>
<p>Il existe plusieurs mode DTP :
<img alt="img" src="../../images/Cisco/VLAN-secure/dtp_mode-1.png" />
<div align="center"><strong><em>Illustration 4 :</em></strong> <em>Mode DTP.</em></div></p>
<p>Et ces mode mènent à plusieurs résultats :
<img alt="img" src="../../images/Cisco/VLAN-secure/dtp_mode-2.png" />
<div align="center"><strong><em>Illustration 5 :</em></strong> <em>Association des modes DTP.</em></div></p>
<hr />
<h3 id="23-attaque">2.3 Attaque :</h3>
<p>Aparavant, je m'assure qu'aucun port et à monter une liason trunk :</p>
<pre><code class="text">SW-1# show interface trunk
</code></pre>

<p>Aucun retour donc aucune interfac n'a été monté en trunk.
Ensuite avec yersinia :</p>
<pre><code class="bash">yersinia -G
</code></pre>

<p>Je me rend dans DTP -&gt; Launc attack -&gt; Enabling trunking -&gt; OK</p>
<p>Je retourne sur le switch :</p>
<pre><code class="text">SW-1# show interface trunk
</code></pre>

<p><img alt="img" src="../../images/Cisco/VLAN-secure/mount-trunk.png" />
<div align="center"><strong><em>Illustration 6 :</em></strong> <em>Port de cascade.</em></div></p>
<p>L'interface de l'attaquant est monté en trunk.</p>
<hr />
<h3 id="24-mitigation">2.4 Mitigation :</h3>
<p>Il faut désactiver le protocle DTP vers tous les postes clients :</p>
<pre><code class="text">SW-1(config)# interface &lt;toutes-les-interfaces-vers-les-clients&gt;
SW-1(config-if)# switchport mode access
SW-1(config-if)# switchport nonegotiate
</code></pre>

<p>Je recommande de priviligé de désactiver DTP sur les ports de cascades et de monter manuellement les liasons trunk.</p>
<hr />
<h2 id="3-conclusion">3 Conclusion :</h2>
<p>Nous avons vu deux attaques sur les vlan :</p>
<ul>
<li>Double tagging</li>
<li>Switch spoof</li>
</ul>
<p>Pour mitiguer ces deux attaques :
* Changer la valeur du vlan natif et ne pas laisser de ports de clients dans un vlan qui n'est pas définis en access sur un vlan précis,
* Désactiver le protocole DTP sur tous les ports </p>
<hr />
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../S%C3%A9curiser%20les%20mots%20de%20passe/" class="btn btn-neutral float-right" title="Sécuriser - Les mots de passe sur Cisco :">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../S%C3%A9curiser%20ARP%20et%20DHCP/" class="btn btn-neutral" title="Sécuriser - ARP et DHCP :"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../S%C3%A9curiser%20ARP%20et%20DHCP/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../S%C3%A9curiser%20les%20mots%20de%20passe/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
